# service_quotas.jinja - AFT Global Customizations template
# This template automatically requests Security Group quota increases for new accounts
# Generated by AFT Global Customizations framework

terraform {
  required_version = ">= 1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

# Default provider (account's primary region)
provider "aws" {
  region = "{{ account.region | default('eu-west-2') }}"
  
  default_tags {
    tags = {
      Project     = "AFT-Security-Group-Quota-Automation"
      Environment = "{{ account.environment | default('production') }}"
      ManagedBy   = "AFT-Global-Customizations"
      Purpose     = "Security-Group-Quota-Automation"
      AccountId   = "{{ account.id }}"
      AccountName = "{{ account.name | default('Unknown') }}"
    }
  }
}

# US-East-1 provider alias (required for global Security Group quotas)
# This MUST be us-east-1 regardless of account's primary region
provider "aws" {
  alias  = "us_east_1"
  region = "us-east-1"
  
  default_tags {
    tags = {
      Project     = "AFT-Security-Group-Quota-Automation"
      Environment = "{{ account.environment | default('production') }}"
      ManagedBy   = "AFT-Global-Customizations"
      Purpose     = "Security-Group-Quota-Automation"
      AccountId   = "{{ account.id }}"
      AccountName = "{{ account.name | default('Unknown') }}"
    }
  }
}

# Security Group rules quota increase request
# This automatically requests an increase from 60 to 200 rules per security group
resource "aws_servicequotas_service_quota" "sg_rules_quota" {
  provider = aws.us_east_1
  
  service_code = "{{ quota_config.service_code | default('vpc') }}"
  quota_code   = "{{ quota_config.quota_code | default('L-0EA8095F') }}"
  value        = {{ quota_config.target_value | default(200) }}
  
  tags = {
    Name        = "Security-Group-Rules-Quota-{{ account.id }}"
    Description = "Automated quota increase for Security Group rules per SG"
    RequestedBy = "AFT-Global-Customizations"
    AccountId   = "{{ account.id }}"
    AccountName = "{{ account.name | default('Unknown') }}"
    Environment = "{{ account.environment | default('production') }}"
  }
}

# Outputs for AFT logging and validation
output "aft_security_group_quota_info" {
  description = "Security Group quota automation results"
  value = {
    account_id       = "{{ account.id }}"
    account_name     = "{{ account.name | default('Unknown') }}"
    primary_region   = "{{ account.region | default('eu-west-2') }}"
    quota_region     = "us-east-1"
    
    current_quota = {
      service_code    = data.aws_servicequotas_service_quota.sg_rules_current.service_code
      quota_code      = data.aws_servicequotas_service_quota.sg_rules_current.quota_code
      quota_name      = data.aws_servicequotas_service_quota.sg_rules_current.quota_name
      current_value   = data.aws_servicequotas_service_quota.sg_rules_current.value
      default_value   = data.aws_servicequotas_service_quota.sg_rules_current.default_value
      adjustable      = data.aws_servicequotas_service_quota.sg_rules_current.adjustable
    }
    
    quota_request = {
      service_code     = aws_servicequotas_service_quota.sg_rules_quota.service_code
      quota_code       = aws_servicequotas_service_quota.sg_rules_quota.quota_code
      requested_value  = aws_servicequotas_service_quota.sg_rules_quota.value
      request_id       = aws_servicequotas_service_quota.sg_rules_quota.id
      request_status   = aws_servicequotas_service_quota.sg_rules_quota.request_status
      arn              = aws_servicequotas_service_quota.sg_rules_quota.arn
    }
  }
}

output "aft_next_steps" {
  description = "Next steps for quota request monitoring"
  value = [
    "1. Check AWS Service Quotas console in us-east-1 for request status",
    "2. Monitor request_id: ${aws_servicequotas_service_quota.sg_rules_quota.id}",
    "3. AWS will review and approve/deny the request (1-2 business days)",
    "4. Re-run AFT pipeline to check updated status",
    "5. Quota will be automatically applied upon AWS approval"
  ]
}
