# service_quotas.jinja - AFT Global Customizations template
# This template automatically requests Security Group quota increases for new accounts
# Generated by AFT Global Customizations framework

terraform {
  required_version = ">= 1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

# US-East-1 provider alias (required for global Security Group quotas)
# This MUST be us-east-1 regardless of account's primary region
# Note: AFT already provides default provider, so we only need the alias
provider "aws" {
  alias  = "us_east_1"
  region = "us-east-1"
  
  default_tags {
    tags = {
      Project     = "AFT-Security-Group-Quota-Automation"
      Environment = "production"
      ManagedBy   = "AFT-Global-Customizations"
      Purpose     = "Security-Group-Quota-Automation"
      Timestamp   = "{{ timestamp }}"
    }
  }
}

# Data source to get current caller identity (account ID)
data "aws_caller_identity" "current" {
  provider = aws.us_east_1
}

# Security Group rules quota increase request
# This automatically requests an increase from 60 to 200 rules per security group
# Note: Requires ServiceQuotas permissions to be granted to AWSAFTExecution role manually
resource "aws_servicequotas_service_quota" "sg_rules_quota" {
  provider = aws.us_east_1
  
  service_code = var.quota_service_code
  quota_code   = var.quota_code
  value        = var.target_quota_value
}

# Outputs for AFT logging and validation
output "aft_security_group_quota_info" {
  description = "Security Group quota automation results"
  value = {
    account_id       = data.aws_caller_identity.current.account_id
    primary_region   = var.account_region
    quota_region     = "us-east-1"
    timestamp        = var.aft_timestamp
    
    quota_request = {
      service_code     = aws_servicequotas_service_quota.sg_rules_quota.service_code
      quota_code       = aws_servicequotas_service_quota.sg_rules_quota.quota_code
      requested_value  = aws_servicequotas_service_quota.sg_rules_quota.value
      request_id       = aws_servicequotas_service_quota.sg_rules_quota.id
      request_status   = aws_servicequotas_service_quota.sg_rules_quota.request_status
      arn              = aws_servicequotas_service_quota.sg_rules_quota.arn
    }
  }
}

output "aft_next_steps" {
  description = "Next steps for quota request monitoring"
  value = [
    "1. Check AWS Service Quotas console in us-east-1 for request status",
    "2. Monitor request_id: ${aws_servicequotas_service_quota.sg_rules_quota.id}",
    "3. AWS will review and approve/deny the request (1-2 business days)",
    "4. Re-run AFT pipeline to check updated status",
    "5. Quota will be automatically applied upon AWS approval"
  ]
}

output "aft_quota_automation_metadata" {
  description = "Metadata for quota automation tracking"
  value = {
    name        = "Security-Group-Rules-Quota-${data.aws_caller_identity.current.account_id}"
    description = "Automated quota increase for Security Group rules per SG"
    requested_by = "AFT-Global-Customizations"
    account_id   = data.aws_caller_identity.current.account_id
    environment  = "production"
    timestamp    = var.aft_timestamp
    automation   = "aft-security-group-quota"
    service_code = var.quota_service_code
    quota_code   = var.quota_code
    target_value = var.target_quota_value
    note         = "ServiceQuotas permissions required for AWSAFTExecution role"
  }
}

# Output instructions for manual IAM setup
output "aft_required_permissions" {
  description = "Required IAM permissions that need to be added manually"
  value = {
    role_name = "AWSAFTExecution"
    required_policy = {
      Version = "2012-10-17"
      Statement = [
        {
          Effect = "Allow"
          Action = [
            "servicequotas:GetServiceQuota",
            "servicequotas:GetAWSDefaultServiceQuota", 
            "servicequotas:ListServiceQuotas",
            "servicequotas:RequestServiceQuotaIncrease",
            "servicequotas:GetRequestedServiceQuotaChange",
            "servicequotas:ListRequestedServiceQuotaChangeHistory"
          ]
          Resource = "*"
        }
      ]
    }
    instructions = [
      "1. Manually attach ServiceQuotas permissions to AWSAFTExecution role",
      "2. Use the policy JSON provided in required_policy output",
      "3. This enables quota automation to read current quotas and submit requests",
      "4. Without these permissions, only quota requests will work (no current quota info)"
    ]
  }
}